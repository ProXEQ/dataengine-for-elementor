import{autocompletion,closeBrackets,completionKeymap,startCompletion}from"@codemirror/autocomplete";import{defaultKeymap,indentWithTab}from"@codemirror/commands";import{html}from"@codemirror/lang-html";import{EditorState,RangeSetBuilder}from"@codemirror/state";import{oneDark}from"@codemirror/theme-one-dark";import{Decoration,EditorView,keymap,ViewPlugin}from"@codemirror/view";import{linter,lintGutter}from"@codemirror/lint";jQuery(document).ready((function(e){const t={delim:Decoration.mark({class:"cm-de-delim"}),source:Decoration.mark({class:"cm-de-source"}),separator:Decoration.mark({class:"cm-de-separator"}),field:Decoration.mark({class:"cm-de-field"}),property:Decoration.mark({class:"cm-de-property"}),pipe:Decoration.mark({class:"cm-de-pipe"}),filter:Decoration.mark({class:"cm-de-filter"}),conditional:Decoration.mark({class:"cm-de-conditional"})},o=EditorView.baseTheme({"& .cm-de-delim":{color:"#ff6900",fontWeight:"bold"},"& .cm-de-source":{color:"#00bcff",fontWeight:"bold"},"& .cm-de-separator":{color:"#fdc700"},"& .cm-de-field":{color:"#b8e6fe"},"& .cm-de-property":{color:"#8ec5ff"},"& .cm-de-pipe":{color:"#fdc700",fontWeight:"bold"},"& .cm-de-filter":{color:"#fff085"},"& .cm-de-conditional":{color:"#bbf451",fontStyle:"italic"},".cm-lintRange-error":{backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3E%3Cpath d='M0 1.5 L8 1.5 M0 3.5 L8 3.5 M0 5.5 L8 5.5' stroke='%23e06c75' stroke-width='1.2'/%3E%3C/svg%3E\")",backgroundRepeat:"repeat-x",backgroundPosition:"bottom"},".cm-tooltip-lint":{backgroundColor:"#3b2323",border:"1px solid #e06c75",color:"#e06c75"}}),n=ViewPlugin.fromClass(class{constructor(e){this.decorations=this.buildDecorations(e)}update(e){(e.docChanged||e.viewportChanged)&&(this.decorations=this.buildDecorations(e.view))}buildDecorations(e){const o=new RangeSetBuilder,n=[];for(const{from:o,to:i}of e.visibleRanges){const r=e.state.doc.sliceString(o,i),a=/\[\/?if[^\]]*\]|\[else(?: if)?[^\]]*\]/g;let s;for(;null!==(s=a.exec(r));){const e=o+s.index,i=e+s[0].length;n.push({from:e,to:i,decoration:t.conditional})}const c=/(%)([\w]+)(:)([\w.-]+)(?:\s*(\|)\s*([^%]*?))?(%)/g;for(;s=c.exec(r);){const e=o+s.index;let i=e;n.push({from:i,to:i+s[1].length,decoration:t.delim}),i+=s[1].length,n.push({from:i,to:i+s[2].length,decoration:t.source}),i+=s[2].length,n.push({from:i,to:i+s[3].length,decoration:t.separator}),i+=s[3].length;const r=s[4];if(r.includes(".")){const e=r.indexOf(".");n.push({from:i,to:i+e,decoration:t.field}),n.push({from:i+e,to:i+e+1,decoration:t.separator}),n.push({from:i+e+1,to:i+r.length,decoration:t.property})}else n.push({from:i,to:i+r.length,decoration:t.field});if(i+=r.length,s[5]&&void 0!==s[6]){i+=s[0].substring(i-e).match(/^\s*/)[0].length,n.push({from:i,to:i+1,decoration:t.pipe}),i+=1;i+=s[0].substring(i-e).match(/^\s*/)[0].length;const o=s[6].trimEnd();n.push({from:i,to:i+o.length,decoration:t.filter}),i+=o.length,i+=s[6].length-o.length}const a=s[0].lastIndexOf("%");if(a>0){const o=e+a;n.push({from:o,to:o+1,decoration:t.delim})}}}n.sort(((e,t)=>e.from-t.from));for(const{from:e,to:t,decoration:i}of n)n.some((o=>o!==i&&o.from<t&&o.to>e&&o.from<e))||o.add(e,t,i);return o.finish()}},{decorations:e=>e.decorations});function i(t,i,r,a){e("body").append('\n            <div class="data-engine-modal">\n                <div class="modal-header">DataEngine Live Editor</div>\n                <div class="modal-content"></div>\n                <div class="modal-footer">\n                    <button class="elementor-button" id="de-cancel-button">Cancel</button>\n                    <button class="elementor-button elementor-button-success" id="de-save-button">Save & Close</button>\n                </div>\n            </div>');const s=document.querySelector(".data-engine-modal .modal-content"),c=(l=i,e=>{const t=e.state.doc.lineAt(e.pos),o=t.text,n=e.pos-t.from,i=o.substring(0,n).match(/%([^%]*)$/);if(!i)return null;const r=i[1],a=e.pos-r.length,s=r.lastIndexOf(".");if(s>0){const e=r.substring(0,s);if(e.includes(":")){const[t,o]=e.split(":");if("acf"===t&&l.acf){const e=l.acf.find((e=>e.name===o));if(e&&e.properties)return{from:a+s+1,options:e.properties.map((e=>({label:e.name,type:"property",info:e.label,apply:(t,o,n,i)=>{const r="%"!==t.state.doc.sliceString(i,i+1)?`${e.name}%`:e.name;t.dispatch({changes:{from:n,to:i,insert:r},selection:{anchor:n+r.length}})}}))),validFor:/^[\w-]*$/}}}return null}const c=r.indexOf(":");if(c>0){const e=r.substring(0,c);return l[e]?{from:a+c+1,options:l[e].map((e=>({label:e.name,type:"variable",info:e.label,apply:(t,o,n,i)=>{const r=e.properties&&e.properties.length>0;let a;a=r?`${e.name}.`:"%"!==t.state.doc.sliceString(i,i+1)?`${e.name}%`:e.name,t.dispatch({changes:{from:n,to:i,insert:a},selection:{anchor:n+a.length}}),r&&setTimeout((()=>{startCompletion(t)}),10)}}))),validFor:/^[\w-]*$/}:null}return{from:a,options:["acf","post","sub"].map((e=>({label:e,type:"namespace",info:`Data from "${e}" source`,apply:(t,o,n,i)=>{const r=`${e}:`;t.dispatch({changes:{from:n,to:i,insert:r},selection:{anchor:n+r.length}}),setTimeout((()=>{startCompletion(t)}),10)}}))),validFor:/^\w*$/}});var l;const d=(e=>linter((t=>{let o=[];const n=t.state.doc.toString(),i=/%([a-zA-Z0-9_.-]+:[a-zA-Z0-9_.-]+(?:\|[^%]+)?)%/g;let r;for(;r=i.exec(n);){const t=r[1].split("|")[0],[n,i]=t.split(":");if(["acf","post","sub"].includes(n)){if(i){const t=i.split(".")[0];e[n]&&!e[n].some((e=>e.name===t))&&o.push({from:r.index+1+n.length+1,to:r.index+1+n.length+1+t.length,severity:"error",message:`Field '${t}' not found in '${n}' source.`})}}else o.push({from:r.index+1,to:r.index+1+n.length,severity:"error",message:`Unknown data source: '${n}'. Available: acf, post, sub.`})}return o})))(i),m=EditorState.create({doc:t,extensions:[oneDark,EditorView.lineWrapping,html(),o,n,closeBrackets(),autocompletion({override:[c],activateOnTyping:!0,maxRenderedOptions:20}),d,lintGutter(),keymap.of([...completionKeymap,...defaultKeymap,indentWithTab,{key:"Escape",run:t=>(e("#de-cancel-button").click(),!0)}])]}),p=new EditorView({state:m,parent:s});e("#de-cancel-button").on("click",(function(){a(),e(".data-engine-modal").remove()})),e("#de-save-button").on("click",(function(){r(p.state.doc.toString()),e(".data-engine-modal").remove()}))}function r(t){e(".data-engine-overlay").remove(),e("body").append(`<div class="data-engine-overlay">${t}</div>`),setTimeout((()=>e(".data-engine-overlay").addClass("is-visible")),10)}function a(){e(".data-engine-overlay").removeClass("is-visible").delay(300).queue((function(){e(this).remove()}))}e("#elementor-panel").on("click",'button.elementor-button[data-event="data-engine:launch-editor"]',(function(){const t=e(this).closest(".elementor-control").prev(".elementor-control-type-textarea").find("textarea");if(!t.length)return;r('<div class="data-engine-loader"><div class="spinner"></div><div class="status-text">Fetching data dictionary...</div></div>');const o=elementor.config.document,n={action:"data_engine_get_data_dictionary",nonce:DataEngineEditorConfig.nonce};o.preview&&o.preview.id?n.preview_id=o.preview.id:n.post_id=o.id,e.ajax({url:DataEngineEditorConfig.ajax_url,type:"POST",data:n,success:function(o){o.success?(e(".data-engine-overlay .status-text").text("Initializing editor..."),setTimeout((function(){e(".data-engine-overlay").empty(),i(t.val(),o.data,(e=>{t.val(e).trigger("input"),r('<div class="data-engine-success"><div class="icon-checkmark">âœ“</div><div>Saved successfully!</div></div>'),setTimeout(a,1500)}),(()=>{a()}))}),300)):(a(),alert("Error: Could not fetch data dictionary from the server. "+(o.data?.message||"")))},error:function(e,t,o){a(),alert("Error: The AJAX request to the server failed. "+t)}})}))}));